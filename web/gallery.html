// ============================================
// è¦³å®¢ç”¨BOT - Cloudflare R2å¯¾å¿œç‰ˆï¼ˆæ”¹å–„ç‰ˆï¼‰
// ============================================

// ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¸€åº¦ã ã‘èª­ã¿è¾¼ã¿ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼‰
const PROPS = PropertiesService.getScriptProperties();
const CONFIG = {
  LINE_ACCESS_TOKEN: PROPS.getProperty('LINE_ACCESS_TOKEN'),
  R2_UPLOAD_WORKER_URL: PROPS.getProperty('R2_UPLOAD_WORKER_URL'),
  WORKER_AUTH_TOKEN: PROPS.getProperty('WORKER_AUTH_TOKEN'),
  R2_PUBLIC_URL: PROPS.getProperty('R2_PUBLIC_URL'),
  MAX_IMAGE_SIZE_MB: 10 // ç”»åƒã‚µã‚¤ã‚ºä¸Šé™ï¼ˆMBï¼‰
};

// å®šæ•°
const SHEET_NAME = 'å†™çœŸæŠ•ç¨¿';
const MAX_IMAGE_SIZE_BYTES = CONFIG.MAX_IMAGE_SIZE_MB * 1024 * 1024;

// ============================================
// LINE Webhookå—ä¿¡
// ============================================
function doPost(e) {
  try {
    if (!e || !e.postData) {
      return ContentService.createTextOutput(JSON.stringify({status: 'ok'}));
    }

    const json = JSON.parse(e.postData.contents);
    const events = json.events;
    
    if (!events) return ContentService.createTextOutput('ok');

    events.forEach(event => {
      if (event.type === 'message') {
        const userId = event.source.userId;
        const replyToken = event.replyToken;
        
        // ç”»åƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
        if (event.message.type === 'image') {
          handleImageMessage(event.message.id, userId, replyToken);
        }
      }
      // ã‚¹ã‚¿ãƒƒãƒ•Botã‹ã‚‰ã®ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆæŒ‡ç¤º
      else if (event.type === 'message' && event.message.type === 'text') {
        if (event.message.text.startsWith('[BROADCAST]')) {
          const message = event.message.text.replace('[BROADCAST]', '').trim();
          broadcastToAllUsers(message);
        }
      }
    });
    
    return ContentService.createTextOutput(JSON.stringify({status: 'ok'}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    Logger.log('doPost ã‚¨ãƒ©ãƒ¼: ' + error);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ============================================
// ç”»åƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
// ============================================
function handleImageMessage(messageId, userId, replyToken) {
  try {
    // è¨­å®šãƒã‚§ãƒƒã‚¯
    if (!CONFIG.R2_UPLOAD_WORKER_URL || !CONFIG.WORKER_AUTH_TOKEN) {
      Logger.log('ã‚¨ãƒ©ãƒ¼: R2è¨­å®šãŒä¸å®Œå…¨ã§ã™');
      replyMessage(replyToken, 'âš ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚¨ãƒ©ãƒ¼\nç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„');
      return;
    }

    // LINEã‹ã‚‰ç”»åƒã‚’å–å¾—
    const imageResult = getImageFromLine(messageId);
    
    if (!imageResult.success) {
      Logger.log('ç”»åƒå–å¾—å¤±æ•—: ' + imageResult.error);
      replyMessage(replyToken, 'âš ï¸ ç”»åƒã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ\n' + imageResult.error);
      return;
    }
    
    const { blob, contentType, size } = imageResult;
    
    // ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
    if (size > MAX_IMAGE_SIZE_BYTES) {
      const sizeMB = (size / (1024 * 1024)).toFixed(2);
      Logger.log(`ç”»åƒã‚µã‚¤ã‚ºè¶…é: ${sizeMB}MB`);
      replyMessage(replyToken, `âš ï¸ ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™\næœ€å¤§: ${CONFIG.MAX_IMAGE_SIZE_MB}MB / é€ä¿¡: ${sizeMB}MB`);
      return;
    }
    
    // R2ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    const timestamp = new Date().getTime();
    const extension = getExtensionFromMimeType(contentType);
    const filename = `photo_${timestamp}_${messageId}${extension}`;
    
    const uploadResult = uploadToR2(blob, filename, contentType);
    
    if (!uploadResult.success) {
      Logger.log('R2ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + uploadResult.error);
      replyMessage(replyToken, 'âš ï¸ ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ\nã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„');
      return;
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—
    const userName = getUserName(userId);
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²
    savePhotoRecord(uploadResult.url, uploadResult.url, userName, userId, messageId, contentType);
    
    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const sizeMB = (size / (1024 * 1024)).toFixed(2);
    replyMessage(replyToken, `ğŸ“¸ å†™çœŸã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼\n\nã‚µã‚¤ã‚º: ${sizeMB}MB\nã‚®ãƒ£ãƒ©ãƒªãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¾ã™`);
    
    Logger.log(`âœ“ å†™çœŸå—ä¿¡æˆåŠŸ: ${userName} (${sizeMB}MB) â†’ ${uploadResult.url}`);
    
  } catch (error) {
    Logger.log('ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + error.stack || error);
    replyMessage(replyToken, 'âš ï¸ ç”»åƒã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
  }
}

// ============================================
// LINEã‹ã‚‰ç”»åƒå–å¾—ï¼ˆæ”¹å–„ç‰ˆï¼‰
// ============================================
function getImageFromLine(messageId) {
  const url = `https://api-data.line.me/v2/bot/message/${messageId}/content`;
  
  try {
    const response = UrlFetchApp.fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + CONFIG.LINE_ACCESS_TOKEN
      },
      muteHttpExceptions: true
    });
    
    const statusCode = response.getResponseCode();
    
    if (statusCode !== 200) {
      return {
        success: false,
        error: `HTTP ${statusCode}: ${response.getContentText()}`
      };
    }
    
    const blob = response.getBlob();
    const contentType = response.getHeaders()['Content-Type'] || 'image/jpeg';
    const size = blob.getBytes().length;
    
    Logger.log(`ç”»åƒå–å¾—æˆåŠŸ: ${contentType}, ${(size / 1024).toFixed(2)}KB`);
    
    return {
      success: true,
      blob: blob,
      contentType: contentType,
      size: size
    };
    
  } catch (error) {
    return {
      success: false,
      error: error.toString()
    };
  }
}

// ============================================
// R2ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ”¹å–„ç‰ˆï¼‰
// ============================================
function uploadToR2(blob, filename, contentType) {
  try {
    Logger.log(`R2ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${filename} (${contentType})`);
    
    const response = UrlFetchApp.fetch(CONFIG.R2_UPLOAD_WORKER_URL, {
      method: 'post',
      contentType: 'application/octet-stream',
      payload: blob.getBytes(),
      headers: {
        'X-Filename': filename,
        'X-Content-Type': contentType,
        'X-Auth-Token': CONFIG.WORKER_AUTH_TOKEN
      },
      muteHttpExceptions: true
    });
    
    const statusCode = response.getResponseCode();
    const responseText = response.getContentText();
    
    Logger.log(`Workerå¿œç­”: HTTP ${statusCode}`);
    Logger.log(`Workerå¿œç­”å†…å®¹: ${responseText}`);
    
    if (statusCode !== 200) {
      return {
        success: false,
        error: `Worker error (${statusCode}): ${responseText}`
      };
    }
    
    try {
      const result = JSON.parse(responseText);
      
      if (result.success) {
        return {
          success: true,
          url: result.url
        };
      } else {
        return {
          success: false,
          error: result.error || 'Unknown error'
        };
      }
    } catch (parseError) {
      return {
        success: false,
        error: `JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${parseError.toString()}`
      };
    }
    
  } catch (error) {
    Logger.log('R2ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¾‹å¤–: ' + error.stack || error);
    return {
      success: false,
      error: error.toString()
    };
  }
}

// ============================================
// MIMEã‚¿ã‚¤ãƒ—ã‹ã‚‰æ‹¡å¼µå­ã‚’å–å¾—
// ============================================
function getExtensionFromMimeType(mimeType) {
  const mimeMap = {
    'image/jpeg': '.jpg',
    'image/jpg': '.jpg',
    'image/png': '.png',
    'image/gif': '.gif',
    'image/webp': '.webp',
    'image/bmp': '.bmp'
  };
  
  return mimeMap[mimeType.toLowerCase()] || '.jpg';
}

// ============================================
// ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—
// ============================================
function getUserName(userId) {
  const url = `https://api.line.me/v2/bot/profile/${userId}`;
  
  try {
    const response = UrlFetchApp.fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + CONFIG.LINE_ACCESS_TOKEN
      },
      muteHttpExceptions: true
    });
    
    if (response.getResponseCode() === 200) {
      const profile = JSON.parse(response.getContentText());
      return profile.displayName || 'æŠ•ç¨¿è€…';
    }
  } catch (error) {
    Logger.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—ã‚¨ãƒ©ãƒ¼: ' + error);
  }
  
  return 'æŠ•ç¨¿è€…';
}

// ============================================
// å†™çœŸè¨˜éŒ²ã‚’ä¿å­˜
// ============================================
function savePhotoRecord(fullImageUrl, thumbnailUrl, userName, userId, messageId, contentType) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName(SHEET_NAME);
    
    // ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
    if (!sheet) {
      sheet = ss.insertSheet(SHEET_NAME);
      sheet.appendRow([
        'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—',
        'ãƒ¦ãƒ¼ã‚¶ãƒ¼å',
        'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID',
        'ç”»åƒURLï¼ˆãƒ•ãƒ«ï¼‰',
        'ç”»åƒURLï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ï¼‰',
        'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID',
        'MIMEã‚¿ã‚¤ãƒ—'
      ]);
      sheet.getRange(1, 1, 1, 7).setFontWeight('bold');
    }
    
    const now = Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy-MM-dd HH:mm:ss');
    sheet.appendRow([now, userName, userId, fullImageUrl, thumbnailUrl, messageId, contentType]);
    
    Logger.log(`âœ“ ã‚·ãƒ¼ãƒˆè¨˜éŒ²å®Œäº†: ${userName}`);
    
  } catch (error) {
    Logger.log('ã‚·ãƒ¼ãƒˆè¨˜éŒ²ã‚¨ãƒ©ãƒ¼: ' + error);
    throw error;
  }
}

// ============================================
// LINEè¿”ä¿¡
// ============================================
function replyMessage(replyToken, message) {
  const url = 'https://api.line.me/v2/bot/message/reply';
  
  try {
    UrlFetchApp.fetch(url, {
      method: 'post',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + CONFIG.LINE_ACCESS_TOKEN
      },
      payload: JSON.stringify({
        replyToken: replyToken,
        messages: [{ type: 'text', text: message }]
      }),
      muteHttpExceptions: true
    });
  } catch (error) {
    Logger.log('LINEè¿”ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error);
  }
}

// ============================================
// ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆæ©Ÿèƒ½
// ============================================
function broadcastToAllUsers(message) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const userSheet = ss.getSheetByName('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§');
    
    if (!userSheet || userSheet.getLastRow() <= 1) {
      Logger.log('ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ: å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—');
      return;
    }
    
    const userData = userSheet.getDataRange().getValues();
    const userIds = [];
    
    for (let i = 1; i < userData.length; i++) {
      if (userData[i][1]) {
        userIds.push(userData[i][1]);
      }
    }
    
    if (userIds.length === 0) {
      Logger.log('ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ: æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDãªã—');
      return;
    }
    
    // LINE Messaging APIã®ãƒãƒ«ãƒã‚­ãƒ£ã‚¹ãƒˆ
    const url = 'https://api.line.me/v2/bot/message/multicast';
    const payload = {
      to: userIds.slice(0, 500), // æœ€å¤§500ãƒ¦ãƒ¼ã‚¶ãƒ¼
      messages: [{ type: 'text', text: message }]
    };
    
    const response = UrlFetchApp.fetch(url, {
      method: 'post',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + CONFIG.LINE_ACCESS_TOKEN
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    });
    
    Logger.log(`ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé€ä¿¡: ${userIds.length}äºº, HTTP ${response.getResponseCode()}`);
    
  } catch (error) {
    Logger.log('ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error);
  }
}

// ============================================
// Web API: ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
// ============================================
function doGet(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(SHEET_NAME);
    
    if (!sheet || sheet.getLastRow() <= 1) {
      return ContentService.createTextOutput(JSON.stringify({
        lastUpdate: Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy-MM-dd HH:mm:ss'),
        photos: []
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    const data = sheet.getDataRange().getValues();
    const photos = [];
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆi=1ã‹ã‚‰ï¼‰
    for (let i = 1; i < data.length; i++) {
      if (data[i][3]) { // ç”»åƒURLãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿
        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        let formattedTimestamp = '';
        if (data[i][0]) {
          if (data[i][0] instanceof Date) {
            formattedTimestamp = Utilities.formatDate(data[i][0], 'Asia/Tokyo', 'yyyy-MM-dd HH:mm:ss');
          } else if (typeof data[i][0] === 'string') {
            // ã™ã§ã«æ–‡å­—åˆ—ã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
            formattedTimestamp = data[i][0];
          }
        }
        
        photos.push({
          timestamp: formattedTimestamp,
          userName: data[i][1],
          fullImage: data[i][3],
          thumbnail: data[i][4] || data[i][3], // ã‚µãƒ ãƒã‚¤ãƒ«ãŒãªã„å ´åˆã¯ãƒ•ãƒ«ç”»åƒ
          contentType: data[i][6] || 'image/jpeg'
        });
      }
    }
    
    // æ–°ã—ã„é †ã«ä¸¦ã³æ›¿ãˆ
    photos.reverse();
    
    return ContentService.createTextOutput(JSON.stringify({
      lastUpdate: Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy-MM-dd HH:mm:ss'),
      photos: photos
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log('doGet ã‚¨ãƒ©ãƒ¼: ' + error);
    return ContentService.createTextOutput(JSON.stringify({
      error: error.toString(),
      photos: []
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ============================================
// è¨­å®šç¢ºèªç”¨é–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
// ============================================
function checkConfig() {
  Logger.log('=== è¨­å®šç¢ºèª ===');
  Logger.log('LINE_ACCESS_TOKEN: ' + (CONFIG.LINE_ACCESS_TOKEN ? 'âœ“ è¨­å®šæ¸ˆã¿' : 'âœ— æœªè¨­å®š'));
  Logger.log('R2_UPLOAD_WORKER_URL: ' + (CONFIG.R2_UPLOAD_WORKER_URL || 'âœ— æœªè¨­å®š'));
  Logger.log('WORKER_AUTH_TOKEN: ' + (CONFIG.WORKER_AUTH_TOKEN ? 'âœ“ è¨­å®šæ¸ˆã¿' : 'âœ— æœªè¨­å®š'));
  Logger.log('R2_PUBLIC_URL: ' + (CONFIG.R2_PUBLIC_URL || 'âœ— æœªè¨­å®š'));
  Logger.log('MAX_IMAGE_SIZE_MB: ' + CONFIG.MAX_IMAGE_SIZE_MB);
}
