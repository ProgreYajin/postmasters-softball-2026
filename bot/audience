// â˜…â˜…â˜… è¨­å®šé …ç›® â˜…â˜…â˜…
const PROPS = PropertiesService.getScriptProperties();
const LINE_ACCESS_TOKEN = PROPS.getProperty('LINE_ACCESS_TOKEN');
const DRIVE_FOLDER_ID = PROPS.getProperty('DRIVE_FOLDER_ID');

// ã‚·ãƒ¼ãƒˆåå®šç¾©
const SHEET_AUDIENCE = 'è¦³å®¢ãƒªã‚¹ãƒˆ';
const SHEET_PHOTOS = 'å†™çœŸãƒªã‚¹ãƒˆ';

// LINE Webhook & é€£æºAPI
function doPost(e) {
  try {
    if (!e || !e.postData) {
      return ContentService.createTextOutput(JSON.stringify({status: 'ok'}));
    }

    const json = JSON.parse(e.postData.contents);

    // 1. ã‚¹ã‚¿ãƒƒãƒ•Botã‹ã‚‰ã®å®Ÿæ³é…ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡
    if (json.type === 'broadcast' && json.message) {
      pushToAllAudience(json.message);
      return ContentService.createTextOutput(JSON.stringify({status: 'broadcast_sent'}))
        .setMimeType(ContentService.MimeType.JSON);
    }

    // 2. LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡
    const events = json.events;
    if (events) {
      events.forEach(event => {
        if (event.type === 'follow') {
          handleFollow(event);
        } else if (event.type === 'message') {
          if (event.message.type === 'image') {
            handleImage(event);
          } else if (event.message.type === 'text') {
            handleText(event);
          }
        }
      });
    }
    
    return ContentService.createTextOutput(JSON.stringify({status: 'ok'}))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    console.error('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:', error);
    return ContentService.createTextOutput(JSON.stringify({status: 'error'}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// å‹ã ã¡è¿½åŠ å‡¦ç†ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
function handleFollow(event) {
  const userId = event.source.userId;
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_AUDIENCE);
  
  // æ—¢ã«ç™»éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
  const data = sheet.getDataRange().getValues();
  const isExist = data.some(row => row[0] === userId);

  if (!isExist) {
    const timestamp = Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy/MM/dd HH:mm:ss');
    sheet.appendRow([userId, timestamp, 'active']);
  }
  
  const welcomeMessage = `ã‚ˆã†ã“ã!ã‚½ãƒ•ãƒˆãƒœãƒ¼ãƒ«å¤§ä¼šã¸ğŸ‰

ã“ã®Botã§ã§ãã‚‹ã“ã¨:
ğŸ“Š è©¦åˆã®å¾—ç‚¹é€Ÿå ±ãŒè‡ªå‹•ã§å±Šãã¾ã™
ğŸ“¸ å†™çœŸã‚’é€ã‚‹ã¨å…¬å¼ã‚µã‚¤ãƒˆã«æ²è¼‰ã•ã‚Œã¾ã™

å¿œæ´ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™!âš¾`;
  
  replyMessage(event.replyToken, welcomeMessage);
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getUserName(userId) {
  try {
    const url = `https://api.line.me/v2/bot/profile/${userId}`;
    const options = {
      headers: {
        'Authorization': 'Bearer ' + LINE_ACCESS_TOKEN
      },
      method: 'get',
      muteHttpExceptions: true
    };
    
    const response = UrlFetchApp.fetch(url, options);
    if (response.getResponseCode() === 200) {
      const profile = JSON.parse(response.getContentText());
      return profile.displayName || 'åå‰å–å¾—å¤±æ•—';
    }
  } catch (error) {
    console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
  }
  return 'åå‰å–å¾—å¤±æ•—';
}

// ç”»åƒå—ä¿¡å‡¦ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰
function handleImage(event) {
  const messageId = event.message.id;
  const userId = event.source.userId;
  const replyToken = event.replyToken;
  
  try {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
    const userName = getUserName(userId);
    
    const imageBlob = getImageFromLine(messageId);
    const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const timestamp = Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyyMMdd_HHmmss');
    const fileName = `photo_${timestamp}.jpg`;
    
    const file = folder.createFile(imageBlob.setName(fileName));
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    const fileId = file.getId();
    
    // â˜…ã‚µãƒ ãƒã‚¤ãƒ«ç”¨URLï¼ˆä¸€è¦§è¡¨ç¤ºç”¨ãƒ»è»½é‡ï¼‰
    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;
    
    // â˜…ãƒ•ãƒ«ç”»åƒç”¨URLï¼ˆã‚¯ãƒªãƒƒã‚¯æ™‚è¡¨ç¤ºç”¨ãƒ»é«˜ç”»è³ªï¼‰
    const fullImageUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const photoSheet = ss.getSheetByName(SHEET_PHOTOS);
    const displayDate = Utilities.formatDate(new Date(), 'Asia/Tokyo', 'MM/dd HH:mm');
    
    // Aåˆ—:æ—¥æ™‚, Båˆ—:ãƒ¦ãƒ¼ã‚¶ãƒ¼ID, Cåˆ—:ãƒ¦ãƒ¼ã‚¶ãƒ¼å, Dåˆ—:ã‚µãƒ ãƒã‚¤ãƒ«URL, Eåˆ—:ãƒ•ãƒ«ç”»åƒURL
    photoSheet.appendRow([displayDate, userId, userName, thumbnailUrl, fullImageUrl]);
    
    replyMessage(replyToken, 'ğŸ“¸ å†™çœŸã‚’å—ã‘å–ã‚Šã¾ã—ãŸ!\nå…¬å¼ã‚µã‚¤ãƒˆã«æ²è¼‰ã•ã‚Œã¾ã™ã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™!');
    
  } catch (error) {
    console.error('ç”»åƒä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    replyMessage(replyToken, 'âš ï¸ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  }
}

// ãƒ†ã‚­ã‚¹ãƒˆå—ä¿¡å‡¦ç†
function handleText(event) {
  const message = event.message.text;
  const replyToken = event.replyToken;
  
  if (message.includes('è©¦åˆ') || message.includes('ã‚¹ã‚³ã‚¢')) {
    // â˜…GitHub Pagesã®URLã«å¤‰æ›´ã—ã¦ãã ã•ã„
    const SITE_URL = 'https://ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å.github.io/softball-scoreboard/';
    replyMessage(replyToken, `ğŸ“Š æœ€æ–°ã®ã‚¹ã‚³ã‚¢ã¯ã“ã¡ã‚‰ã§ã”è¦§ã„ãŸã ã‘ã¾ã™:\n${SITE_URL}`);
  } else {
    replyMessage(replyToken, 'ã”é€£çµ¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™!\nå†™çœŸã‚’é€ã£ã¦ã„ãŸã ãã¨å…¬å¼ã‚µã‚¤ãƒˆã«æ²è¼‰ã•ã‚Œã¾ã™ğŸ“¸');
  }
}

// LINEã‹ã‚‰ç”»åƒãƒã‚¤ãƒŠãƒªã‚’å–å¾—
function getImageFromLine(messageId) {
  const url = `https://api-data.line.me/v2/bot/message/${messageId}/content`;
  const options = {
    headers: {
      'Authorization': 'Bearer ' + LINE_ACCESS_TOKEN
    },
    method: 'get'
  };
  return UrlFetchApp.fetch(url, options).getBlob();
}

// æ±ç”¨: è¿”ä¿¡å‡¦ç†
function replyMessage(replyToken, message) {
  const url = 'https://api.line.me/v2/bot/message/reply';
  postToLine(url, {
    replyToken: replyToken,
    messages: [{ type: 'text', text: message }]
  });
}

// å…¨å“¡ã¸ã®Pushé€ä¿¡ï¼ˆBroadcast APIä½¿ç”¨ï¼‰
function pushToAllAudience(message) {
  const url = 'https://api.line.me/v2/bot/message/broadcast';
  
  try {
    postToLine(url, {
      messages: [{ type: 'text', text: message }]
    });
    console.log('ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé€ä¿¡å®Œäº†:', message);
  } catch (e) {
    console.error('ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼:', e);
  }
}

// æ±ç”¨: LINE APIã¸ã®POSTå®Ÿè¡Œ
function postToLine(url, payload) {
  const options = {
    method: 'post',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + LINE_ACCESS_TOKEN
    },
    payload: JSON.stringify(payload)
  };
  UrlFetchApp.fetch(url, options);
}

// Webå…¬é–‹ç”¨: å†™çœŸãƒªã‚¹ãƒˆJSON API
function doGet(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const photoSheet = ss.getSheetByName(SHEET_PHOTOS);
  
  // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®å‡¦ç†
  if (photoSheet.getLastRow() <= 1) {
    return ContentService.createTextOutput(JSON.stringify({
      lastUpdate: Utilities.formatDate(new Date(), 'Asia/Tokyo', 'HH:mm:ss'),
      photos: []
    })).setMimeType(ContentService.MimeType.JSON);
  }

  const data = photoSheet.getDataRange().getValues();
  const photos = [];
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é™¤ã„ã¦å–å¾—
  // Aåˆ—:æ—¥æ™‚, Båˆ—:ãƒ¦ãƒ¼ã‚¶ãƒ¼ID, Cåˆ—:ãƒ¦ãƒ¼ã‚¶ãƒ¼å, Dåˆ—:ã‚µãƒ ãƒã‚¤ãƒ«URL, Eåˆ—:ãƒ•ãƒ«ç”»åƒURL
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] && data[i][3] && data[i][4]) {
      photos.push({
        timestamp: data[i][0],
        userId: data[i][1],
        userName: data[i][2] || 'æŠ•ç¨¿è€…',
        thumbnail: data[i][3],
        fullImage: data[i][4]
      });
    }
  }
  
  const result = {
    lastUpdate: Utilities.formatDate(new Date(), 'Asia/Tokyo', 'HH:mm:ss'),
    photos: photos.reverse() // æ–°ã—ã„é †
  };
  
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}
